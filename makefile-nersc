D?=0
MAXDIM?=200

ifeq ($(D),1)
FLAGS=-O0 -g -fsanitize=address -fno-omit-frame-pointer -std=c++20 -DMAX_DIM=$(MAXDIM)
else
FLAGS=-O3 -std=c++20 -DMAX_DIM=$(MAXDIM)
endif

COMPILER=CC
INCLUDES=-I./include

PY_INCLUDES=-I/global/common/software/nersc/pe/conda-envs/24.1.0/python-3.11/nersc-python/include/python3.11 \
			-I/global/common/software/nersc/pe/conda-envs/24.1.0/python-3.11/nersc-python/lib/python3.11/site-packages/mpi4py/include
PY_FLAGS=-shared -fPIC

.PHONY: clean bindings

all: rgraph bindings

rgraph: rgraph.cpp src/cover_tree.cpp src/dist_point_vector.cpp src/point_vector.cpp src/dist_graph.cpp src/utils.cpp src/timer.cpp src/ghost_tree.cpp src/work_stealer.cpp
	$(COMPILER) -o $@ $(INCLUDES) $(FLAGS) $^

bindings: bindings/metricspace.cpp src/cover_tree.cpp src/dist_point_vector.cpp src/point_vector.cpp src/dist_graph.cpp src/utils.cpp src/timer.cpp src/ghost_tree.cpp src/work_stealer.cpp
	$(COMPILER) $(FLAGS) $(PY_FLAGS) $(INCLUDES) $(PY_INCLUDES) $^ -o metricspace.so

clean:
	rm -rf *.dSYM *.so rgraph
